# Protected application
server {
  listen 443 ssl;
  listen 80;
  server_name httpbin.localhost.pomerium.io;
  ssl_certificate /etc/nginx/nginx.pem;
  ssl_certificate_key /etc/nginx/nginx-key.pem;

  include /etc/nginx/ext_authz.conf;

  location @authblock {
    internal;
    add_header Set-Cookie $auth_cookie;
    return 302
      https://fwdauth.localhost.pomerium.io/?uri=$scheme://$host$request_uri;
  }

  location / {
    proxy_pass http://httpbin;
    include /etc/nginx/auth.conf;
    include /etc/nginx/proxy.conf;

    # match nginx-ingress
    set $pass_access_scheme $scheme;
    set $best_http_host $http_host;
  }
}
